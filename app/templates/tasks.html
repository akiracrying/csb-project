{% extends "base.html" %}
{% block title %}Tasks - TaskFlow{% endblock %}
{% block content %}
<h1>Tasks</h1>
<button class="btn" onclick="showCreateForm()">Create Task</button>
<div id="createForm" style="display:none; margin: 20px 0; border: 1px solid #ddd; padding: 15px; border-radius: 3px;">
    <h3>Create New Task</h3>
    <div class="form-group">
        <label>Team:</label>
        <select id="taskTeamId" required>
            <option value="">Select a team...</option>
        </select>
        <small>Don't have a team? <a href="/teams">Create one first</a></small>
    </div>
    <div class="form-group">
        <label>Title:</label>
        <input type="text" id="taskTitle" placeholder="Task title" required>
    </div>
    <div class="form-group">
        <label>Description:</label>
        <textarea id="taskDescription" placeholder="Task description"></textarea>
    </div>
    <div class="form-group">
        <label>Status:</label>
        <select id="taskStatus">
            <option value="todo">Todo</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
        </select>
    </div>
    <div class="form-group">
        <label>Priority:</label>
        <select id="taskPriority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
        </select>
    </div>
    <button class="btn" onclick="createTask()">Create</button>
    <button class="btn" onclick="hideCreateForm()" style="background: #6c757d;">Cancel</button>
</div>
<div style="margin: 20px 0;">
    <input type="text" id="search" placeholder="Search tasks..." style="width: 300px; padding: 8px;">
    <button class="btn" onclick="searchTasks()">Search</button>
    <button class="btn" onclick="loadTasks()">Show All</button>
</div>
<div id="tasks"></div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('taskModal').style.display='none'">&times;</span>
        <h2>Task Details (JSON)</h2>
        <div class="json-view" id="modalJsonContent"></div>
    </div>
</div>

<script>
    function getToken() {
        const localToken = localStorage.getItem('token');
        if (localToken) return localToken;
        const value = `; ${document.cookie}`;
        const parts = value.split(`; token=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    const token = getToken();
    if (!token) {
        window.location.href = '/login';
        throw new Error('No token');
    }
    
    fetch('/api/me', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(r => {
        if (!r.ok) {
            window.location.href = '/login';
            throw new Error('Not authenticated');
        }
        return r.json();
    })
    .catch(err => {
        window.location.href = '/login';
    });
    
    const urlParams = new URLSearchParams(window.location.search);
    const teamId = urlParams.get('team_id');
    
    let availableTeams = [];
    
    async function loadTeams() {
        try {
            const res = await fetch('/api/teams', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                availableTeams = await res.json();
                const teamSelect = document.getElementById('taskTeamId');
                if (teamSelect) {
                    teamSelect.innerHTML = '<option value="">Select a team...</option>' +
                        availableTeams.map(t => `<option value="${t.id}">${t.name} (ID: ${t.id})</option>`).join('');
                }
            }
        } catch (err) {
            console.error('Failed to load teams:', err);
        }
    }
    
    async function loadTasks() {
        let url = '/api/tasks';
        if (teamId) url += '?team_id=' + teamId;
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const tasks = await res.json();
        displayTasks(tasks);
    }
    
    async function searchTasks() {
        const search = document.getElementById('search').value;
        let url = '/api/tasks?search=' + encodeURIComponent(search);
        if (teamId) url += '&team_id=' + teamId;
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const tasks = await res.json();
        displayTasks(tasks);
    }
    
    function displayTasks(tasks) {
        if (tasks.length === 0) {
            document.getElementById('tasks').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No tasks found</p>';
            return;
        }
        document.getElementById('tasks').innerHTML = tasks.map(t => {
            const statusClass = t.status === 'done' ? 'badge-done' : t.status === 'in_progress' ? 'badge-progress' : 'badge-todo';
            const priorityClass = t.priority === 'high' ? 'badge-high' : t.priority === 'medium' ? 'badge-medium' : 'badge-low';
            return `
            <div class="task-card">
                <h3>${t.title}</h3>
                <p>${t.description || 'No description'}</p>
                <div class="task-meta">
                    <span class="badge ${statusClass}">${t.status.replace('_', ' ')}</span>
                    <span class="badge ${priorityClass}">${t.priority}</span>
                    <span style="color: #666;">Team ID: ${t.team_id}</span>
                </div>
                <button class="btn" onclick="showTaskDetails(${t.id})" style="margin-top: 10px;">View Details (JSON)</button>
            </div>`;
        }).join('');
    }
    
    async function showTaskDetails(taskId) {
        try {
            const res = await fetch(`/api/tasks/${taskId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) {
                alert('Failed to load task details');
                return;
            }
            const task = await res.json();
            const modal = document.getElementById('taskModal');
            const modalContent = document.getElementById('modalJsonContent');
            modalContent.textContent = JSON.stringify(task, null, 2);
            modal.style.display = 'block';
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('taskModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    function showCreateForm() {
        document.getElementById('createForm').style.display = 'block';
    }
    
    function hideCreateForm() {
        document.getElementById('createForm').style.display = 'none';
    }
    
    async function createTask() {
        const teamId = parseInt(document.getElementById('taskTeamId').value);
        const title = document.getElementById('taskTitle').value;
        const description = document.getElementById('taskDescription').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        
        if (!teamId || !title) {
            alert('Team ID and Title are required');
            return;
        }
        
        try {
            const res = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_id: teamId,
                    title: title,
                    description: description,
                    status: status,
                    priority: priority
                })
            });
            
            const result = await res.json();
            if (res.ok) {
                alert('Task created successfully!');
                hideCreateForm();
                loadTasks();
            } else {
                alert('Error: ' + (result.error || 'Failed to create task'));
            }
        } catch (err) {
            alert('Network error: ' + err.message);
        }
    }
    
    loadTeams();
    loadTasks();
</script>
{% endblock %}

